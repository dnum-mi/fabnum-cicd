name: Update chart

on:
  workflow_call:
    inputs:
      RUN_MODE:
        description: Mode the workflow is run in. 'caller' to trigger the workflow in the chart repository, 'called' to update the chart in the current repository
        required: true
        type: string
      WORKFLOW_NAME:
        description: Name of the workflow to trigger in the chart repository (eg. 'update-chart.yml')
        required: false
        type: string
        default: update-app-version.yml
      CHART_REPO:
        description: Name of the chart repository (eg. 'this-is-tobi/helm-charts')
        required: false
        type: string
      CHART_DIR:
        description: Name of the folder containing the chart (in CHART_REPO)
        required: false
        type: string
        default: charts
      CHART_NAME:
        description: Name of the folder containing the chart (in CHART_DIR)
        required: true
        type: string
      APP_VERSION:
        description: The app version to inject in Chart.yaml
        required: true
        type: string
      UPGRADE_TYPE:
        description: Should update 'major', 'minor', 'patch' or 'prerelease'
        required: false
        type: string
        default: patch
      PRERELEASE_IDENTIFIER:
        description: Prerelease identifier (only used if UPGRADE_TYPE is 'prerelease')
        required: false
        type: string
        default: rc
      RUNS_ON:
        description: Runner labels as JSON array (e.g., '["ubuntu-24.04"]' or '["self-hosted", "linux"]')
        required: false
        type: string
        default: '["ubuntu-24.04"]'
    secrets:
      GH_PAT:
        description: GitHub Personal Access Token (needed for automerge)
        required: false

permissions:
  pull-requests: write
  contents: write
  actions: write

jobs:
  caller:
    name: Update chart
    runs-on: ${{ fromJSON(inputs.RUNS_ON) }}
    if: ${{ inputs.RUN_MODE == 'caller' }}
    steps:
    - name: Trigger helm-charts update
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
      run: |
        # Remove trailing slashes
        CHART_DIR=$(echo '${{ inputs.CHART_DIR }}' | sed 's:/*$::')

        if [ -z "${{ inputs.CHART_REPO }}" ]; then
          echo "CHART_REPO input is required when using 'caller' mode"
          exit 1
        fi

        echo "Trigger workflow '${{ inputs.WORKFLOW_NAME }}' in repository '${{ inputs.CHART_REPO }}' to update chart '$CHART_DIR/${{ inputs.CHART_NAME }}' with app version '${{ inputs.APP_VERSION }}'"

        gh workflow --repo ${{ inputs.CHART_REPO }} run ${{ inputs.WORKFLOW_NAME }} \
          -f APP_VERSION=${{inputs.APP_VERSION }} \
          -f CHART_NAME=${{ inputs.CHART_NAME }} \
          -f UPGRADE_TYPE=${{ inputs.UPGRADE_TYPE }} \
          -f PRERELEASE_IDENTIFIER=${{ inputs.PRERELEASE_IDENTIFIER }} \
          -f RUN_MODE=called

  called:
    name: Update chart
    runs-on: ${{ fromJSON(inputs.RUNS_ON) }}
    if: ${{ inputs.RUN_MODE == 'called' }}
    steps:
    - name: Checks-out repository
      uses: actions/checkout@v5

    - name: update chart version
      id: update-chart
      run: |
        # Remove trailing slashes
        CHART_DIR=$(echo '${{ inputs.CHART_DIR }}' | sed 's:/*$::')

        if [ ! -f $CHART_DIR/${{ inputs.CHART_NAME }}/Chart.yaml ]; then
          echo "Chart.yaml not found in $CHART_DIR/${{ inputs.CHART_NAME }}"
          exit 1
        fi

        echo "Update chart '${{ inputs.CHART_NAME }}' in $CHART_DIR/${{ inputs.CHART_NAME }} with app version '${{ inputs.APP_VERSION }}'"
        CURRENT_VERSION=$(yq '.version' ${{ inputs.CHART_DIR }}/${{ inputs.CHART_NAME }}/Chart.yaml)

        # Bump version using Release Please compatible logic
        if [[ "${{ inputs.UPGRADE_TYPE }}" == "prerelease" ]]; then
          # Parse version: extract base version and prerelease part
          if [[ $CURRENT_VERSION =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-(.+))?$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            PRERELEASE="${BASH_REMATCH[5]}"
            
            if [[ -z "$PRERELEASE" ]]; then
              # No prerelease: add first prerelease without number (Release Please style)
              NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}-${{ inputs.PRERELEASE_IDENTIFIER }}"
            elif [[ "$PRERELEASE" == "${{ inputs.PRERELEASE_IDENTIFIER }}" ]]; then
              # Has prerelease without number: '1.0.0-rc' -> '1.0.0-rc.1'
              NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}-${{ inputs.PRERELEASE_IDENTIFIER }}.1"
            elif [[ "$PRERELEASE" =~ ^${{ inputs.PRERELEASE_IDENTIFIER }}\.([0-9]+)$ ]]; then
              # Has numbered prerelease: increment the number
              NUM="${BASH_REMATCH[1]}"
              NEXT_NUM=$((NUM + 1))
              NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}-${{ inputs.PRERELEASE_IDENTIFIER }}.${NEXT_NUM}"
            else
              echo "Unexpected prerelease format: $PRERELEASE"
              exit 1
            fi
          else
            echo "Invalid version format: $CURRENT_VERSION"
            exit 1
          fi
        else
          # Standard version bump (major, minor, patch)
          if [[ $CURRENT_VERSION =~ ^([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            
            case "${{ inputs.UPGRADE_TYPE }}" in
              major)
                NEXT_VERSION="$((MAJOR + 1)).0.0"
                ;;
              minor)
                NEXT_VERSION="${MAJOR}.$((MINOR + 1)).0"
                ;;
              patch)
                NEXT_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
                ;;
              *)
                echo "Invalid upgrade type: ${{ inputs.UPGRADE_TYPE }}"
                exit 1
                ;;
            esac
          else
            echo "Invalid version format: $CURRENT_VERSION"
            exit 1
          fi
        fi
        
        echo "Update chart from version '$CURRENT_VERSION' to '$NEXT_VERSION'"

        echo "Update chart files..."
        sed -i "s/^appVersion: .*/appVersion: ${{ inputs.APP_VERSION }}/" $CHART_DIR/${{ inputs.CHART_NAME }}/Chart.yaml
        sed -i "s/^version: .*/version: $NEXT_VERSION/" $CHART_DIR/${{ inputs.CHART_NAME }}/Chart.yaml

        echo "Generate chart documentation..."
        docker run \
          --rm \
          --volume "$(pwd)/$CHART_DIR/${{ inputs.CHART_NAME }}:/helm-docs" \
          -u $(id -u) \
          docker.io/jnorwood/helm-docs:latest

        echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "NEXT_VERSION=$NEXT_VERSION" >> $GITHUB_OUTPUT
        echo "BRANCH_NAME=${{ inputs.CHART_NAME }}-v$NEXT_VERSION" >> $GITHUB_OUTPUT

    - name: Create pull request
      uses: peter-evans/create-pull-request@v7
      with:
        branch: ${{ steps.update-chart.outputs.BRANCH_NAME }}
        base: main
        title: Update chart ${{ inputs.CHART_NAME }} app to v${{ inputs.APP_VERSION }}
        add-paths: |
          **/**
        commit-message: "chore: update chart ${{ inputs.CHART_NAME }} app to v${{ inputs.APP_VERSION }}"
        draft: false
        body: |
          ðŸ¤– This PR has been automatically generated, please check updates before merging.

          - Chart version has been updated from `${{ steps.update-chart.outputs.CURRENT_VERSION }}` to `${{ steps.update-chart.outputs.NEXT_VERSION }}`
          - App version has been updated to `${{ inputs.APP_VERSION }}`
          - Chart documentation has been regenerated
