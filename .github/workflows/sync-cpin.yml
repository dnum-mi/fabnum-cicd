name: Trigger CPiN synchro

on:
  workflow_call:
    inputs:
      GITLAB_URL:
        description: Url of the CPiN Gitlab instance.
        required: true
        type: string
      GIT_MIRROR_PROJECT_ID:
        description: Gitlab project ID of the mirror repository.
        required: true
        type: string
      BRANCH_TO_SYNC:
        description: Git branch to synchronize.
        required: false
        type: string
      SYNC_ALL:
        description: Whether to synchronize all branches or just the specified one.
        required: false
        type: boolean
        default: false
      REPOSITORY_NAME:
        description: Gitlab repository to synchronize.
        required: true
        type: string
      ADDITIONAL_VARIABLES:
        description: Additional variables to pass to GitLab pipeline (JSON format, e.g., '{"VAR1":"value1","VAR2":"value2"}').
        required: false
        type: string
      RUNS_ON:
        description: Runner labels as JSON array (e.g., '["ubuntu-24.04"]' or '["self-hosted", "linux"]')
        required: false
        type: string
        default: '["ubuntu-24.04"]'
    secrets:
      GIT_MIRROR_TOKEN:
        description: Gitlab token used to perfom the synchronization.
        required: true

jobs:
  trigger-dso:
    name: Trigger CPiN synchro
    runs-on: ${{ fromJSON(inputs.RUNS_ON) }}
    steps:
      - name: Send request to CPiN api
        shell: bash
        run: |
          # Start building curl command array
          CURL_ARGS=(
            -X POST
            -fsSL
            -F "token=${{ secrets.GIT_MIRROR_TOKEN }}"
            -F "ref=main"
            -F "variables[PROJECT_NAME]=${{ secrets.REPOSITORY_NAME || inputs.REPOSITORY_NAME }}"
            -F "variables[GITHUB_COMMIT_SHA]=${{ github.sha }}"
          )
          
          # Handle branch synchronization based on SYNC_ALL
          if [ "${{ inputs.SYNC_ALL }}" = "true" ]; then
            echo "Synchronizing all branches..."
            CURL_ARGS+=(-F "variables[SYNC_ALL]=true")
          else
            echo "Synchronizing branch: ${{ inputs.BRANCH_TO_SYNC }}"
            CURL_ARGS+=(-F "variables[GIT_BRANCH_DEPLOY]=${{ inputs.BRANCH_TO_SYNC }}")
          fi
          
          # Add additional variables if provided
          if [ -n "${{ inputs.ADDITIONAL_VARIABLES }}" ]; then
            echo "Processing additional variables..."
            
            # Read JSON and parse it safely
            while IFS= read -r key && IFS= read -r value; do
              if [ -n "$key" ]; then
                CURL_ARGS+=(-F "variables[$key]=$value")
                echo "Adding variable: $key"
              fi
            done < <(echo '${{ inputs.ADDITIONAL_VARIABLES }}' | jq -r 'to_entries | .[] | (.key, .value)')
          fi
          
          # Add the API endpoint URL
          GITLAB_URL=$(echo '${{ inputs.GITLAB_URL }}' | sed 's:/*$::')
          CURL_ARGS+=("$GITLAB_URL/api/v4/projects/${{ inputs.GIT_MIRROR_PROJECT_ID }}/trigger/pipeline")
          
          # Execute the curl command
          curl "${CURL_ARGS[@]}"
          
          if [ "${{ inputs.SYNC_ALL }}" = "true" ]; then
            echo "Syncing all branches of repository '${{ inputs.REPOSITORY_NAME }}' with CPiN."
          else
            echo "Syncing repository '${{ inputs.REPOSITORY_NAME }}' (branch ${{ inputs.BRANCH_TO_SYNC }}) with CPiN."
          fi
