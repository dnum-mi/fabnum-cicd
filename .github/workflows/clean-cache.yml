name: Clean cache

on:
  workflow_call:
    inputs:
      PR_NUMBER:
        description: ID number of the pull request assiocited with the cache
        required: false
        type: number
      BRANCH_NAME:
        description: Branch name assiocited with the cache
        required: false
        type: string
      IMAGE:
        description: Name of the image to delete from ghcr.io (eg. 'my-org/my-image:my-tag')
        required: false
        type: string

permissions:
  packages: write
  contents: read
  actions: write

jobs:
  cleanup-cache:
    name: Delete github cache
    runs-on: ubuntu-latest
    if: ${{ inputs.PR_NUMBER || inputs.BRANCH_NAME }}
    steps:
    - name: Clean cache for closed branch
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        REPO=${{ github.repository }}
        if [ -n "${{ inputs.BRANCH_NAME }}" ]; then
          BRANCH="${{ inputs.BRANCH_NAME }}"
        elif [ -n "${{ inputs.PR_NUMBER }}" ]; then
          BRANCH="refs/pull/${{ inputs.PR_NUMBER }}/merge"
        fi

        echo "Fetching list of cache key"
        CACHE_KEYS=$(gh cache list -R $REPO -r $BRANCH -L 100 | cut -f 1)

        ## Setting this to not fail the workflow while deleting cache keys.
        set +e
        echo "Deleting caches..."
        for CACHE_KEY in $CACHE_KEYS; do
          gh cache delete $CACHE_KEY -R $REPO
        done
        echo "Done"

  cleanup-image:
    name: Delete image from ghcr.io
    runs-on: ubuntu-latest
    if: ${{ inputs.IMAGE }}
    steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: 'ghcr.io'
        username: ${{ github.actor }}
        password: ${{ github.token }}
        logout: true

    - name: Delete ${{ inputs.IMAGE }} image
      env:
        IMAGE: ${{ inputs.IMAGE }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Color definitions
        red='\033[0;31m'
        green='\033[0;32m'
        yellow='\033[0;33m'
        no_color='\033[0m'
        
        REGISTRY_CHECK="${IMAGE%%/*}"
        if [[ "$REGISTRY_CHECK" == *.* || "$REGISTRY_CHECK" == *:* || "$REGISTRY_CHECK" == "localhost" ]]; then
          IMAGE_WITHOUT_REGISTRY="${IMAGE#*/}"
          PROCESSED_IMAGE="${IMAGE_WITHOUT_REGISTRY#*/}"
        else
          IMAGE_WITHOUT_REGISTRY="$IMAGE"
          PROCESSED_IMAGE="${IMAGE_WITHOUT_REGISTRY#*/}"
        fi

        OWNER="${IMAGE_WITHOUT_REGISTRY%%/*}"
        IMAGE_NAME="${PROCESSED_IMAGE%%:*}"
        IMAGE_TAG="${PROCESSED_IMAGE#*:}"
        IMAGE_NAME_URL_ENCODED="$(jq -rn --arg x "${IMAGE_NAME}" '$x | @uri')"

        echo "Detecting owner type for: ${OWNER}"
        OWNER_TYPE="$(curl -fsSL -H "Authorization: Bearer ${GH_TOKEN}" \
          https://api.github.com/users/${OWNER} | jq -r '.type')"
        
        if [ "$OWNER_TYPE" = "Organization" ]; then
          MODE="orgs"
        else
          MODE="users"
        fi
        echo "Owner type: ${OWNER_TYPE}, using API mode: ${MODE}"

        echo "Fetching all versions for ${OWNER}/${IMAGE_NAME}"
        IMAGES=$(gh api -H "Accept: application/vnd.github+json" \
          "/${MODE}/${OWNER}/packages/container/${IMAGE_NAME_URL_ENCODED}/versions" \
          --paginate --jq '.')
        
        MAIN_IMAGE_ID=$(echo "$IMAGES" | jq -r --arg t "$IMAGE_TAG" \
          '.[] | select(.metadata.container.tags[]? | contains($t)) | .id' | head -n1)
        
        if [ -z "$MAIN_IMAGE_ID" ]; then
          printf "${yellow}‚ö†Ô∏è  Image tag '${IMAGE_TAG}' not found for ${OWNER}/${IMAGE_NAME}${no_color}\n"
          echo "::warning::Image tag '${IMAGE_TAG}' not found, skipping deletion"
          exit 0
        fi
        
        echo "Found main image ID: ${MAIN_IMAGE_ID}"

        # Delete manifest images (multi-arch)
        echo "Inspecting multi-arch manifests..."
        if MANIFESTS=$(docker buildx imagetools inspect ghcr.io/${OWNER}/${IMAGE_NAME}:${IMAGE_TAG} --raw 2>/dev/null | jq -r '.manifests[]? | .digest'); then
          while read -r SHA; do
            if [ -n "$SHA" ]; then
              IMAGE_ID=$(echo "$IMAGES" | jq -r --arg s "$SHA" '.[] | select(.name == $s) | .id')
              
              if [ -n "$IMAGE_ID" ]; then
                printf "\n${red}[Delete ghcr image]${no_color} Deleting manifest image '$OWNER/$IMAGE_NAME@$SHA'\n"
                
                if gh api --method DELETE -H "Accept: application/vnd.github+json" \
                  "/${MODE}/${OWNER}/packages/container/${IMAGE_NAME_URL_ENCODED}/versions/${IMAGE_ID}" 2>&1; then
                  printf "${green}‚úÖ Deleted manifest $SHA${no_color}\n"
                else
                  printf "${yellow}‚ö†Ô∏è  Failed to delete manifest $SHA${no_color}\n"
                fi
              fi
            fi
          done <<< "$MANIFESTS"
        else
          echo "No multi-arch manifests found (single-arch image)"
        fi

        # Delete main image
        printf "\n${red}[Delete ghcr image]${no_color} Deleting main image '$OWNER/$IMAGE_NAME:$IMAGE_TAG'\n"
        
        if gh api --method DELETE -H "Accept: application/vnd.github+json" \
          "/${MODE}/${OWNER}/packages/container/${IMAGE_NAME_URL_ENCODED}/versions/${MAIN_IMAGE_ID}" 2>&1; then
          printf "${green}‚úÖ Successfully deleted ${OWNER}/${IMAGE_NAME}:${IMAGE_TAG}${no_color}\n"
          echo "## üóëÔ∏è Image Deleted" >> $GITHUB_STEP_SUMMARY
          echo "Successfully deleted \`${OWNER}/${IMAGE_NAME}:${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
        else
          printf "${red}‚ùå Failed to delete main image${no_color}\n"
          echo "::error::Failed to delete ${OWNER}/${IMAGE_NAME}:${IMAGE_TAG}"
          exit 1
        fi
